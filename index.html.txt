<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --font: Pretendard, -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo",
          "Noto Sans KR", "Malgun Gothic", Arial, sans-serif;
      --bg:#f2f4f7;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#111827;
      --primaryHover:#1f2937;
      --focus:#2563eb;
      --okBg:#dcfce7;
      --okText:#065f46;
      --infoBg:#dbeafe;
      --infoText:#1d4ed8;
      --dangerBg:#fee2e2;
      --dangerText:#991b1b;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      padding:16px;
      background:var(--bg);
      color:var(--text);
      font-family: var(--font);
    }

    .container{max-width:520px;margin:0 auto;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      margin-bottom:12px;
    }

    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;}
    .title{font-size:20px;font-weight:800;margin:0;}

    .field{margin-top:10px;}
    .field label{display:block;font-size:13px;font-weight:700;margin-bottom:6px;}
    .required{color:#dc2626;margin-left:2px;}

    input{
      width:100%;
      border:1px solid #d1d5db;
      border-radius:12px;
      padding:12px;
      font-size:16px;
      background:#fff;
    }

    input:focus{
      outline:none;
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(37,99,235,.15);
    }

    .error{font-size:12px;color:#b91c1c;margin-top:6px;display:none;}

    .btnRow{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;}

    button{
      border:none;
      border-radius:12px;
      padding:12px;
      min-height:44px;
      font-size:15px;
      font-weight:800;
      line-height:1;
      white-space:nowrap;
      cursor:pointer;
    }

    .btnPrimary{background:var(--primary);color:#fff;}
    .btnPrimary:hover{background:var(--primaryHover);}
    .btnSecondary{background:#e5e7eb;color:#111827;}
    .btnDisabled{background:#cbd5e1;color:#64748b;cursor:not-allowed;}

    .result{display:none;}
    .status{
      border-radius:10px;
      padding:10px;
      font-weight:800;
      margin-bottom:10px;
    }
    .sev-success{background:var(--okBg);color:var(--okText);}
    .sev-info{background:var(--infoBg);color:var(--infoText);}
    .sev-danger,.sev-error{background:var(--dangerBg);color:var(--dangerText);}

    .metric{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid #f1f5f9;font-size:14px;}
    .metric:last-of-type{border-bottom:none;}
    .valuePossible{color:#166534;}
    .valueNoLadder{color:#1d4ed8;}
    .valueImpossible{color:#b91c1c;}
    .muted{color:var(--muted);font-size:12px;margin-top:8px;}
    ul{margin:8px 0 0 18px;padding:0;}
    li{margin:4px 0;font-size:13px;}

    .footer{text-align:center;color:var(--muted);font-size:11px;margin-top:10px;}

    /* 컨텐츠(카드) 바깥 상단 로고 영역 */
    .brandBar{
      display:flex;
      align-items:center;
      justify-content:space-between; /* ✅ 양끝 */
      margin: 4px 2px 10px;
      width:100%;
    }

    .brandLogo{
      height:35px;
      width:auto;
      opacity:.9;
    }
    .logo{
      height:24px;
      width:auto;
      flex-shrink:0;
      margin-top: 8px;
      margin-right: 10px; /* ← 8~16px 정도로 취향 조절 */
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="brandBar">
    <img class="brandLogo" src="data:<?= outerLogoMime ?>;base64,<?= outerLogoBase64 ?>" alt="상단 로고">
    <img class="logo" src="data:<?= logoMime ?>;base64,<?= logoBase64 ?>" alt="안전보건공단 로고">
    </div>

    <div class="card">
      <div class="top">
        <h1 class="title">KOSHA 사다리 안전</h1>
      </div>

      <form id="mainForm" novalidate>
        <div class="field">
          <label for="siteNameInput">현장명</label>
          <input id="siteNameInput" type="text" maxlength="80" placeholder="예: OO빌딩" autocomplete="organization" />
        </div>

        <div class="field">
          <label for="taskPlaceInput">세부장소</label>
          <input id="taskPlaceInput" type="text" maxlength="80" placeholder="예: 기계실" />
        </div>

        <div class="field">
          <label for="workContent">작업내용</label>
          <input id="workContent" type="text" maxlength="120" placeholder="예: 전등교체" />
        </div>

        <div class="field">
          <label for="targetHeightM">작업 대상 높이 (m) <span class="required">*</span></label>
          <input id="targetHeightM" type="number" step="0.1" min="0.1" placeholder="예: 2.4(바닥 ~ 작업대상까지)" inputmode="decimal" required />
          <div id="heightFieldError" class="error">높이는 0보다 큰 숫자여야 합니다.</div>
        </div>

        <div class="btnRow">
          <button id="calcBtn" class="btnSecondary" type="submit">계산</button>
          <button id="downloadBtn" class="btnDisabled" type="button" onclick="downloadLabel()" disabled>라벨 다운로드</button>
        </div>
      </form>
    </div>

    <div id="result" class="card result" aria-live="polite"></div>
    <div class="footer">운영: 한국산업안전보건공단 서울광역본부 서비스안전부</div>
  </div>

  <script>
    const DEFAULT_SITE_NAME = "<?= siteName ?>";
    const DEFAULT_TASK_PLACE = "<?= taskPlace ?>";
    const LOGO_DATA_URI = "data:<?= logoMime ?>;base64,<?= logoBase64 ?>";

    const LABEL_PRESET = {
      SCREEN_A6: { W: 820, H: 582, M: 22 },
      PRINT_A6_300: { W: 1748, H: 1240, M: 52 }
    };

    let LAST_PAYLOAD = null;
    let LAST_RES = null;
    let IS_CALCULATING = false;
    
    const $ = (id) => document.getElementById(id);

    $('siteNameInput').value = DEFAULT_SITE_NAME || '';
    $('taskPlaceInput').value = DEFAULT_TASK_PLACE || '';

    $('mainForm').addEventListener('submit', function(event){
      event.preventDefault();
      runPreview();
    });

    ['siteNameInput', 'taskPlaceInput', 'workContent', 'targetHeightM'].forEach(function(id){
      $(id).addEventListener('input', function(){
        hideFieldError();
        LAST_RES = null;
        setDownloadEnabled(false);
        $('result').style.display = 'none';
      });
    });

    function getPayload() {
      return {
        siteName: ($('siteNameInput').value || '').trim(),
        taskPlace: ($('taskPlaceInput').value || '').trim(),
        workContent: ($('workContent').value || '').trim(),
        targetHeightM: Number($('targetHeightM').value)
      };
    }

    function validate(payload) {
      if (!isFinite(payload.targetHeightM) || payload.targetHeightM <= 0) {
        return '높이는 0보다 큰 숫자여야 합니다.';
      }
      return '';
    }

    function showFieldError(message) {
      const box = $('heightFieldError');
      box.textContent = message;
      box.style.display = 'block';
      $('targetHeightM').setAttribute('aria-invalid', 'true');
    }

    function hideFieldError() {
      $('heightFieldError').style.display = 'none';
      $('targetHeightM').removeAttribute('aria-invalid');
    }

    function setDownloadEnabled(enabled) {
      const btn = $('downloadBtn');
      btn.disabled = !enabled;
      btn.className = enabled ? 'btnPrimary' : 'btnDisabled';
    }

    function setCalculating(working) {
      IS_CALCULATING = working;
      const btn = $('calcBtn');
      btn.disabled = working;
      btn.className = working ? 'btnDisabled' : 'btnSecondary';
      btn.textContent = working ? '계산 중...' : '계산';
    }

    function runPreview() {
      if (IS_CALCULATING) return;

      const payload = getPayload();
      LAST_PAYLOAD = payload;
      LAST_RES = null;
      setDownloadEnabled(false);

      const error = validate(payload);
      if (error) {
        showFieldError(error);
        return;
      }

      hideFieldError();
      setCalculating(true);

      google.script.run
        .withSuccessHandler(function(res){
          setCalculating(false);
          renderResult(res);
        })
        .withFailureHandler(function(err){
          setCalculating(false);
          alert('오류: ' + (err && err.message ? err.message : err));
        })
        .previewLadder(payload);
    }

    function renderResult(res) {
      const box = $('result');
      box.style.display = 'block';

      if (!res || res.ok !== true) {
        const msg = (res && res.decision && res.decision.reason) ? res.decision.reason : '오류가 발생했습니다.';
        box.innerHTML = '<div class="status sev-error">입력 오류</div><div>' + escapeHtml(msg) + '</div>';
        setDownloadEnabled(false);
        return;
      }

      const sev = (res.ui && res.ui.severity) ? res.ui.severity : 'success';
      const summary = (res.ui && res.ui.summary) ? res.ui.summary : '계산 완료';
      const status = res.decision && res.decision.status ? res.decision.status : '';
      const recommendation = (res.ui && res.ui.recommendation) ? res.ui.recommendation : '';

      const workHeight = formatNum(res.derived && res.derived.workHeightM);
      const ladder = formatNum(res.results && res.results.minAllowedLadderM);
      const ladderText = (status === 'POSSIBLE' && ladder !== '-') ? ladder + ' m' : (status === 'NO_LADDER' ? '불필요' : (status === 'IMPOSSIBLE' ? '작업 금지' : '-'));
      const ppeText = res.ppe && res.ppe.message ? res.ppe.message : '안전모 / 안전대 착용';

      const legalArr = Array.isArray(res.legal) ? res.legal : [];
      const legalHtml = legalArr.length ? ('<ul>' + legalArr.map(function(x){ return '<li>' + x + '</li>'; }).join('') + '</ul>') : '';

      const ladderValueClass = (function(){
        if (status === 'POSSIBLE') return 'valuePossible';
        if (status === 'NO_LADDER') return 'valueNoLadder';
        if (status === 'IMPOSSIBLE') return 'valueImpossible';
        return '';
      })();

      box.innerHTML =
        '<div class="status sev-' + escapeHtml(sev) + '">' + escapeHtml(summary) + '</div>' +
        '<div class="metric"><span>작업 높이</span><b>' + workHeight + ' m</b></div>' +
        '<div class="metric"><span>권장 사다리 최소높이</span><b class="' + ladderValueClass + '">' + escapeHtml(ladderText) + '</b></div>' +
        '<div class="metric"><span>필수 보호구</span><b>' + escapeHtml(ppeText) + '</b></div>' +
        legalHtml +
        (recommendation ? '<div class="muted">' + escapeHtml(recommendation) + '</div>' : '');

      LAST_RES = res;
      setDownloadEnabled(true);
    }

    async function downloadLabel() {
      if (!LAST_PAYLOAD || !LAST_RES) {
        alert('먼저 계산을 완료하세요.');
        return;
      }

      const label = buildLabelData(LAST_PAYLOAD, LAST_RES);
      const { W, H, M } = LABEL_PRESET.SCREEN_A6;
      const s = W / 920;
      const LEFT = M + Math.round(16 * s);
      const RIGHT = W - (M + Math.round(16 * s));
      const textScale = 1.5;

      const canvas = document.createElement('canvas');
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.round(W * dpr);
      canvas.height = Math.round(H * dpr);
      canvas.style.width = W + 'px';
      canvas.style.height = H + 'px';

      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, W, H);

      ctx.strokeStyle = '#0f172a';
      ctx.lineWidth = Math.max(3, Math.round(4 * s));
      ctx.strokeRect(M, M, W - M * 2, H - M * 2);

      const headY = M + Math.round(16 * s);
      const headH = Math.round(78 * s);
      ctx.fillStyle = '#0f172a';
      ctx.font = `800 ${Math.round(28 * s * textScale)}px "Noto Sans KR", Arial, sans-serif`;
      ctx.fillText('사다리 작업구역 세부내용', LEFT + Math.round(18 * s), headY + Math.round(52 * s));

      const logoImg = await loadImage(LOGO_DATA_URI);
      const logoH = Math.round(40 * s);
      const logoW = Math.round(logoImg.width * (logoH / logoImg.height));
      ctx.drawImage(logoImg, RIGHT - logoW - Math.round(16 * s), headY + Math.round(18 * s), logoW, logoH);

      const tableY = headY + headH + Math.round(16 * s);
      const tableH = H - tableY - (M + Math.round(22 * s));
      ctx.strokeStyle = '#334155';
      ctx.lineWidth = Math.max(2, Math.round(3 * s));
      ctx.strokeRect(LEFT, tableY, RIGHT - LEFT, tableH);

      const rows = [
        { key: '현장명 / 세부장소', value: label.place },
        { key: '작업내용', value: label.workName },
        { key: '권장 사다리 최소높이', value: label.minTopText },
        { key: '작업 높이', value: label.workHeightText }
      ];

      const keyW = Math.round(300 * s);
      const rowH = Math.floor(tableH / rows.length);

      for (let i = 0; i < rows.length; i++) {
        const y = tableY + i * rowH;

        if (i > 0) {
          ctx.beginPath();
          ctx.moveTo(LEFT, y);
          ctx.lineTo(RIGHT, y);
          ctx.stroke();
        }

        ctx.beginPath();
        ctx.moveTo(LEFT + keyW, y);
        ctx.lineTo(LEFT + keyW, y + rowH);
        ctx.stroke();

        ctx.fillStyle = '#f8fafc';
        ctx.fillRect(LEFT + 1, y + 1, keyW - 2, rowH - 2);

        ctx.fillStyle = '#0f172a';
        ctx.font = `700 ${Math.round(20 * s * textScale)}px "Noto Sans KR", Arial, sans-serif`;
        wrapText(ctx, rows[i].key, LEFT + Math.round(14 * s), y + Math.round(34 * s), keyW - Math.round(24 * s), Math.round(26 * s), 2);

        ctx.fillStyle = '#111827';
        ctx.font = `700 ${Math.round(24 * s * textScale)}px "Noto Sans KR", Arial, sans-serif`;
        wrapText(ctx, rows[i].value, LEFT + keyW + Math.round(14 * s), y + Math.round(38 * s), (RIGHT - LEFT - keyW - Math.round(24 * s)), Math.round(30 * s), 2);
      }

      const filename = makeFileName(label);
      canvas.toBlob(function(blob){
        if (!blob) {
          alert('다운로드 생성에 실패했습니다.');
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }, 'image/png', 1.0);
    }

    function buildLabelData(payload, res) {
      const status = res.decision && res.decision.status ? res.decision.status : '';
      const place = (payload.siteName || '현장명 미입력') + (payload.taskPlace ? ' / ' + payload.taskPlace : '');
      const workName = payload.workContent || '작업내용 미입력';
      const ladderM = formatNum(res.results && res.results.minAllowedLadderM);
      const workHeightM = formatNum(res.derived && res.derived.workHeightM);

      let minTopText = '-';
      let workHeightText = '-';

      if (status === 'POSSIBLE') {
        minTopText = ladderM + ' m';
        workHeightText = workHeightM + ' m';
      } else if (status === 'NO_LADDER') {
        minTopText = '사다리 불필요';
        workHeightText = workHeightM + ' m';
      } else if (status === 'IMPOSSIBLE') {
        minTopText = '사다리 작업 금지';
        workHeightText = workHeightM + ' m';
      }

      return { place, workName, minTopText, workHeightText };
    }

    function makeFileName(label) {
      const base = (label.place || '라벨').replace(/[\\/:*?"<>|]/g, '_');
      return base + '_라벨.png';
    }

    function loadImage(src) {
      return new Promise(function(resolve, reject){
        const img = new Image();
        img.onload = function(){ resolve(img); };
        img.onerror = reject;
        img.src = src;
      });
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines) {
      const str = String(text || '').trim();
      if (!str) return y;

      const parts = str.includes(' ') ? str.split(' ') : [str];
      let line = '';
      let lines = 0;

      function drawLine(t) {
        ctx.fillText(t, x, y);
        y += lineHeight;
        lines++;
      }

      for (let i = 0; i < parts.length; i++) {
        const word = parts[i];
        const testLine = line ? (line + ' ' + word) : word;

        if (ctx.measureText(testLine).width <= maxWidth) {
          line = testLine;
          continue;
        }

        if (line) {
          if (maxLines && lines >= maxLines) return y;
          drawLine(line);
          line = '';
        }

        let chunk = '';
        for (let j = 0; j < word.length; j++) {
          const t = chunk + word[j];
          if (ctx.measureText(t).width > maxWidth && chunk) {
            if (maxLines && lines >= maxLines) return y;
            drawLine(chunk);
            chunk = word[j];
          } else {
            chunk = t;
          }
        }
        line = chunk;
      }

      if (line) {
        if (maxLines && lines >= maxLines) return y;
        drawLine(line);
      }

      return y;
    }

    function formatNum(x) {
      if (typeof x !== 'number' || !isFinite(x)) return '-';
      return (Math.round(x * 100) / 100).toString();
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>